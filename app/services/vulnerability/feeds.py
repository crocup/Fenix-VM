from pathlib import Path
from app.core.config import DATABASE_IP, DATABASE_PORT, START_YEAR, NOW_YEAR
from app.core.feeds import AbstractDownloadFeeds, result_download_vulnerability
from app.main import dir_path
from app.services.database import MessageProducer, MongoDriver
import requests

path = Path(dir_path, 'feeds')


class NVDNistFeeds(AbstractDownloadFeeds):

    def __init__(self, start, end):
        super().__init__(start, end)
        self.base = "Vulnerability"
        self.collection = "NVD_HASH"
        self.chunk_size = 128

    def send_db(self):
        pass

    def download_feeds(self):
        while self.start <= self.end:
            if not self.check_new_feeds(self.start):
                year = self.start
                url = f"https://nvd.nist.gov/feeds/json/cve/1.1/nvdcve-1.1-{year}.json.zip"
                r = requests.get(url, stream=True)
                with open(str(path) + f"/NVD/{year}.json.zip", 'wb') as fd:
                    for chunk in r.iter_content(chunk_size=self.chunk_size):
                        fd.write(chunk)
                # unzip_feeds
                # send_db
            self.start += 1

    def unzip_feeds(self):
        pass

    def check_new_feeds(self, year):
        """
        проверка хэша в БД. Если его нет, то записывается
        return: Bool
        """
        url = f"https://nvd.nist.gov/feeds/json/cve/1.1/nvdcve-1.1-{year}.meta"
        r = requests.get(url)
        result = r.text.split(":")
        hash_elem = result[-1]
        hash_elem = hash_elem.replace("\n", "").replace("\r", "")
        if not self.check_hash(hash_elem):
            self.send_hash_db(year, hash_elem)
            return False
        return True

    def delete_data_feeds(self):
        pass

    def check_hash(self, hash_element):
        nvd_hash = MessageProducer(MongoDriver(host=DATABASE_IP, port=DATABASE_PORT,
                                               base=self.base, collection=self.collection))
        return nvd_hash.get_count_doc({"hash": hash_element})

    def send_hash_db(self, year, hash_elem):
        nvd_hash = MessageProducer(MongoDriver(host=DATABASE_IP, port=DATABASE_PORT,
                                               base=self.base, collection=self.collection))
        message = {"year": year, "hash": hash_elem}
        new_message = {"hash": hash_elem}
        nvd_hash.update_message(message, new_message)


class CVEMitreFeeds(AbstractDownloadFeeds):

    def send_db(self):
        pass

    def download_feeds(self):
        pass


result_download_vulnerability(NVDNistFeeds(start=START_YEAR, end=NOW_YEAR))
